# 中文字幕空格问题修复

## 问题描述

生成的中文字幕在每个字符之间都加了空格，例如：
- **错误**: "扩 散 模 型 Diffusion Model"
- **正确**: "扩散模型 Diffusion Model"

这导致中文字幕看起来不自然、难以阅读。

## 根本原因

在 `services/deepgramService.ts` 的 `deepgramToSegments` 函数中，拼接单词时无条件地添加空格：

```typescript
// 原来的代码（有问题）
currentSegment.text += ' ' + word.word;  // ❌ 总是添加空格
```

这在英文中是正确的（因为英文单词之间需要空格），但对中文不适用：
- 英文: "hello world" ✅（需要空格）
- 中文: "扩散模型" ✅（不需要空格）

## 解决方案

### 实现智能空格判断

添加了一个 `needsSpace` 辅助函数，智能判断两个单词之间是否需要空格：

```typescript
// 🎯 智能判断是否需要空格的辅助函数
const needsSpace = (prevText: string, nextWord: string): boolean => {
  if (!prevText || !nextWord) return false;
  
  const lastChar = prevText.trim().slice(-1);
  const firstChar = nextWord.trim()[0];
  
  // 中文字符 Unicode 范围
  const isChinese = (char: string) => /[\u4e00-\u9fa5]/.test(char);
  
  // 两个都是中文字符 → 不需要空格
  if (isChinese(lastChar) && isChinese(firstChar)) {
    return false;
  }
  
  // 至少有一个是英文/数字 → 需要空格
  return true;
};

// 拼接时使用智能空格判断
const separator = needsSpace(currentSegment.text, word.word) ? ' ' : '';
currentSegment.text += separator + word.word;
```

### 判断逻辑

1. **中文 + 中文** → 不加空格
   - "扩" + "散" → "扩散" ✅
   
2. **中文 + 英文** → 加空格
   - "模型" + "Diffusion" → "模型 Diffusion" ✅
   
3. **英文 + 中文** → 加空格
   - "Diffusion" + "模型" → "Diffusion 模型" ✅
   
4. **英文 + 英文** → 加空格
   - "Diffusion" + "Model" → "Diffusion Model" ✅

## 测试验证

### 测试场景 1: 纯中文字幕
```
扩散模型是一种生成模型
```
✅ 无多余空格

### 测试场景 2: 中英文混合
```
扩散模型 Diffusion Model 是一种生成模型
```
✅ 中文字符之间无空格，中英文之间有空格

### 测试场景 3: 英文字幕
```
Diffusion Model is a generative model
```
✅ 保持英文单词之间的空格

## 相关文件

- `services/deepgramService.ts` (行 1056-1098)
  - 添加了 `needsSpace` 智能判断函数
  - 修改了单词拼接逻辑

## 测试建议

1. 使用纯中文视频测试
2. 使用中英文混合视频测试
3. 使用纯英文视频测试
4. 检查字幕显示、SRT 导出、翻译功能

## 注意事项

- 中文字符的 Unicode 范围是 `\u4e00-\u9fa5`（常用汉字）
- 不包括中文标点符号（需要时可以扩展）
- 保持了对英文字幕的兼容性

## 用户反馈

用户报告的问题：
1. ✅ **已修复**: 输出字幕中文之间都加了空格
2. ⏳ **待优化**: 涉及到专业术语的字幕生成有点奇怪（需要进一步分析）

## 下一步优化

1. 提高 Deepgram 对专业术语的识别准确率
   - 考虑使用自定义词汇表（Custom Vocabulary）
   - 或使用 Deepgram 的 keywords 参数
   
2. 支持更多 CJK 语言（日文、韩文）
   - 日文汉字: `\u4e00-\u9faf`
   - 日文假名: `\u3040-\u309f`, `\u30a0-\u30ff`
   - 韩文: `\uac00-\ud7af`



