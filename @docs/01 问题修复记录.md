### Fix Record - 2025-01-27

-   **Problem Description:** 重大安全漏洞：当环境变量 `VITE_DEEPGRAM_API_KEY` 设置后，设置面板会显示环境变量中的 API 密钥内容，导致敏感信息泄露。
-   **Root Cause:** 在 `SettingsModal` 组件中，如果用户之前保存的 `deepgramApiKey` 恰好等于环境变量中的值，或者用户从环境变量复制并保存了密钥，设置面板会直接显示这个值，从而暴露了环境变量中的敏感信息。
-   **Solution:** 
    1. 在 `SettingsModal` 组件中添加了对环境变量 `VITE_DEEPGRAM_API_KEY` 的检测
    2. 在 `useEffect` 中增加了安全检查逻辑：如果环境变量存在，并且用户设置的密钥等于环境变量的值，则清除显示的值，防止环境变量的值在 UI 中显示
    3. 这样即使环境变量存在，设置面板也不会显示其内容，确保敏感信息不会被泄露
-   **Impact Scope:**
    -   `components/SettingsModal.tsx` (添加了环境变量检测和安全过滤逻辑)

---

### Fix Record - 2025-01-27

-   **Problem Description:** 
    1. 字幕翻译时如果有音频，需要通过音频生成字幕，但现在都是通过视频帧生成的字幕，没有音频的情况下才使用视频帧
    2. 字幕生成时不确定系统中设置的Deepgram API Key是否可用，需要添加日志显示是否可用
    3. 生成字幕时出现CORS错误，需要检查并处理
-   **Root Cause:** 
    1. 在 `generateResilientSubtitles` 函数中，如果 `pipelineRecommendation` 是 'visual'，会直接使用视觉管道，即使视频有音频轨道。应该优先使用音频生成字幕。
    2. `isDeepgramAvailable` 函数只检查API Key是否存在，没有实际测试API是否可用。
    3. 自定义API调用时，如果API服务器没有设置CORS头，会导致跨域错误，错误信息不够清晰。
-   **Solution:** 
    1. 修改 `generateResilientSubtitles` 函数逻辑：优先检查是否有音频轨道（`hasAudioTrack`），如果有音频轨道，即使推荐管道是 'visual'，也先尝试使用音频管道生成字幕。只有在没有音频轨道时才直接使用视觉管道。
    2. 增强 `isDeepgramAvailable` 函数：不仅检查API Key是否存在，还通过实际调用Deepgram API的 `/v1/projects` 端点来验证API Key是否有效。添加详细的日志输出，包括API Key来源（用户设置或系统环境变量）、Key长度、验证结果等。
    3. 改进 `generateContentWithCustomAPI` 函数的错误处理：添加CORS错误检测，当遇到CORS错误时，提供清晰的中英文错误提示，建议用户启用代理模式。同时改进网络错误的处理，提供更友好的错误信息。
-   **Impact Scope:**
    -   `services/videoProcessingService.ts` (修改字幕生成逻辑，优先使用音频)
    -   `services/deepgramService.ts` (增强API Key可用性检测和日志)
    -   `services/intelligentRouter.ts` (添加Deepgram可用性日志)
    -   `services/geminiService.ts` (改进CORS错误处理和提示)

---

