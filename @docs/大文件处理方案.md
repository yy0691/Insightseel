# 大文件处理方案说明

## 问题背景

之前系统在处理大于4MB的视频文件时，强制要求上传到Supabase Storage，但当Supabase未配置环境变量时会导致整个处理流程失败。

## 新的解决方案

### 处理流程

1. **文件大小检测**
   - 检测上传的视频文件大小
   - 如果 ≤ 4MB：直接通过Vercel函数发送给Deepgram
   - 如果 > 4MB：启动音频压缩流程

2. **客户端音频压缩**（新功能）
   - 使用Web Audio API在浏览器中提取音频
   - 转换为单声道（Mono）
   - 降低采样率至16kHz（语音识别的理想频率）
   - 转换为WAV格式
   - **预期压缩比**：通常可以将文件压缩到原大小的 **10-20%**

3. **压缩后文件处理**
   - 如果压缩后 ≤ 4MB：直接发送给Deepgram（最常见情况）
   - 如果压缩后仍 > 4MB：尝试上传到Supabase Storage（需要配置）

### 技术优势

1. **无需强制配置Supabase**
   - 大多数场景下（50分钟以内的视频），压缩后都能控制在4MB以内
   - 只有极大的文件才需要Supabase

2. **更快的处理速度**
   - 音频文件远小于视频文件
   - 减少网络传输时间

3. **更好的浏览器兼容性**
   - 支持所有现代浏览器（Chrome、Edge、Firefox、Safari）
   - 利用浏览器原生Web Audio API

4. **降级方案完善**
   - 主方案：客户端压缩 → 直接发送
   - 备选方案1：压缩 → 上传Supabase → URL模式
   - 备选方案2：使用Gemini分段处理

## 实际效果示例

### 案例1：50分钟视频（327MB）
- **原始视频**：327MB MP4
- **压缩后音频**：约 2-3MB WAV（16kHz单声道）
- **处理方式**：直接发送，无需Supabase
- **压缩比**：约 100-150x

### 案例2：2小时视频（800MB）
- **原始视频**：800MB MP4
- **压缩后音频**：约 5-6MB WAV
- **处理方式**：上传Supabase（如果配置）或提示用户使用较短片段

## 错误处理

新的错误处理更加友好和指导性：

1. **浏览器不支持**
   ```
   音频压缩不支持
   
   您的浏览器不支持音频提取功能。
   
   解决方案：
   1. 使用 Chrome、Edge 或 Firefox 浏览器
   2. 配置 Supabase Storage 以处理大文件
   3. 使用更小的视频文件（< 4MB）
   ```

2. **压缩后仍太大**
   ```
   压缩后的音频仍然太大 (5.2MB)
   
   尝试上传到存储服务失败：
   Supabase service role key not configured...
   
   建议解决方案：
   1. 配置 Supabase Storage（设置 SUPABASE_SERVICE_ROLE_KEY）
   2. 使用时长更短的视频片段
   3. 联系技术支持
   ```

## 用户体验改进

- ✅ 无需强制登录或配置
- ✅ 大多数视频可以直接处理
- ✅ 清晰的进度提示（"正在压缩音频..."、"使用压缩音频进行转录..."）
- ✅ 友好的错误提示和解决方案
- ✅ 自动选择最佳处理方案

## 配置Supabase（可选）

如果需要处理超长视频（> 2小时），可以配置Supabase Storage：

1. 在Vercel项目设置中添加环境变量：
   - `SUPABASE_URL` 或 `VITE_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`

2. 在Supabase Dashboard中创建存储桶：
   - 名称：`video-uploads`
   - 配置RLS策略以允许上传

## 技术实现

- **音频提取**：`services/audioExtractionService.ts`
- **Deepgram集成**：`services/deepgramService.ts`（已更新）
- **API改进**：`api/get-upload-url.ts`（已优化错误提示）

## 测试建议

1. 测试小文件（< 4MB）：应直接发送，无压缩
2. 测试中等文件（4-100MB，< 1小时）：应压缩后直接发送
3. 测试大文件（> 100MB，1-2小时）：应压缩后直接发送
4. 测试超大文件（> 500MB，> 2小时）：应提示使用较短片段或配置存储


